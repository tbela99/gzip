#!/bin/sh -x
## you need to install uglify-es
# npm install -g uglify-es
## before you run uglify on WSL, you need to install it there
DIR=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
cd $DIR
#
#
#
uglifyjs  --ecma=8 --compress passes=3,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info"]\
  --warn --mangle --keep-fnames --output ./loader.min.js -- ./loader.js
uglifyjs  --ecma=8 --compress passes=3,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info"]\
  --warn --mangle --keep-fnames --output ./cssloader.min.js -- ./cssloader.js
uglifyjs  --ecma=8 --compress passes=3,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info"]\
  --warn --mangle --keep-fnames --output ./imagesloader.min.js -- ./imagesloader.js
#
#
#
cd ./js
# client side javascript
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit this file! */"' --output ./dist/lib.js -- ./lib/lib.js ./lib/lib.ready.js\
  ./lib/lib.utils.js ./lib/lib.event.js ./lib/lib.options.js
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit this file! */"' --output ./dist/lib.images.js --  ./lib/lib.images.js
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit this file! */"' --output ./dist/intersection-observer.js --  ./lib/intersection-observer.js
# ./lib/lib.sw.js
#./localforage-all.js
uglifyjs --compress unsafe=true,passes=3,ecma=8,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle  -- ./dist/lib.js > ./dist/lib.min.js
uglifyjs --compress unsafe=true,passes=3,ecma=8,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle  -- ./dist/lib.images.js > ./dist/lib.images.min.js
uglifyjs --compress unsafe=true,passes=3,ecma=8,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle  -- ./dist/intersection-observer.js > ./dist/intersection-observer.min.js
# echo "/* do not edit! */" > ./localforage-all.js
#----- uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit this file! */"' --output ./dist/localforage.js -- ./localforage/localforage.js ./localforage/localforage-getitems.js\
#-----  ./localforage/localforage-setitems.js ./localforage/localforage-removeitems.js
#----- uglifyjs --compress unsafe=true,passes=3,ecma=8,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle  -- ./dist/localforage.js > ./dist/localforage.min.js
# rm ./localforage-all.js
cd ../worker
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit! */"' --output ./dist/browser.js -- ./browser.js
uglifyjs --compress unsafe=true,passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle toplevel=true -- ./dist/browser.js > ./dist/browser.min.js
#
#
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit! */"' --output ./dist/browser.uninstall.js -- ./browser.uninstall.js
uglifyjs --compress unsafe=true,passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle toplevel=true -- ./dist/browser.uninstall.js > ./dist/browser.uninstall.min.js
#
#
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit! */"' --output ./dist/onesignal.js -- ./onesignal/onesignal.js
uglifyjs --compress passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true --warn --mangle toplevel=true -- ./dist/onesignal.js > ./dist/onesignal.min.js
#
#
uglifyjs --warn --comments all --beautify beautify=true,preamble='"/* do not edit! */"' --ecma=8\
 -- ./serviceworker.js ./types.js ./utils/sw.utils.js ./event/sw.event.promise.js \
  ./network/sw.strategies.js ./network/sw.strategies.network_first.js ./network/sw.strategies.cache_first.js ./network/sw.strategies.cache_network.js\
  ./network/sw.strategies.network_only.js ./network/sw.strategies.cache_only.js\
  ./router/sw.router.js\
  ./db/db.js ./expiration/sw.expiration.js\
  ./serviceworker.config.js\
  ./service/sw.service.install.js ./service/sw.service.activate.js  ./service/sw.service.fetch.js | sed "s/build-date/$(date '+%F %H:%M:%S%:z')/g" | sed "s/build-id/$(git rev-parse --short HEAD)/g"  > ./dist/serviceworker.js
#
uglifyjs --ecma=8 --compress passes=3,toplevel=true,unsafe_comps=true,unsafe_proto=true,warnings=true,pure_funcs=["console.log","console.info"]\
  --warn --mangle toplevel=true -- ./dist/serviceworker.js > ./dist/serviceworker.min.js
#  ./filter/sw.filter.js --mangle-props
#
cd ..
sha1sum worker/dist/serviceworker.js | awk '{print $1;}' > worker_version